<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>瀑布流布局</title>
    <style>
        *{
            padding: 0;
            margin: 0;
        }
        #main{
            position: relative;
        }
        .box{
            padding: 15px 0 0 15px;
            float: left;
        }
        .pic{
            padding: 10px;
            border:1px solid #ccc;
            -webkit-border-radius: 5px;
            -moz-border-radius: 5px;
            border-radius: 5px;
            -webkit-box-shadow: 0 0 5px #ccc;
            -moz-box-shadow: 0 0 5px #ccc;
            box-shadow: 0 0 5px #ccc;
        }
        .pic img{
            width: 165px;
            height:auto;
        }
    </style>
    <script type="text/javascript">
        window.onload=function(){
            waterfall("main","box");
            var dataInt={"data":[{"src":"images/P_00.jpg"},{"src":"images/P_01.jpg"},{"src":"images/P_02.jpg"},{"src":"images/P_03.jpg"}]};
            window.onscroll=function(){
                if(checkScrollSlide()){
                    for(var i=0;i<dataInt.data.length;i++){
                        var oBox=document.createElement("div");
                        var oParent=document.getElementById("main");
                        oBox.className="box";
                        oParent.appendChild(oBox);
                        var oPic=document.createElement("div");
                        oPic.className="pic";
                        oBox.appendChild(oPic);
                        var oImg=document.createElement("img");
                        oImg.src=dataInt.data[i].src;
                        oPic.appendChild(oImg);
                    }
                    waterfall("main","box");
                }
            }
        }
        function waterfall(parent,box) {
            var oParent = document.getElementById(parent);
            var oBoxs=getByClass(oParent, box);
            //计算列数(页面的宽/box的宽)
            var oBoxW=oBoxs[0].offsetWidth;
            var cols=Math.floor(document.documentElement.clientWidth/oBoxW);
            //设置main的宽度
            oParent.style.cssText="width:"+oBoxW*cols+"px;margin:0 auto;";
            var hArr=new Array();//存放每一列的高度
            for(var i=0;i<oBoxs.length;i++){
                if(i<cols){
                    hArr.push(oBoxs[i].offsetHeight);
                }else{
                    var minH=Math.min.apply(null,hArr);
                    var index=hArr.indexOf(minH);
                    //console.log(index);
                    oBoxs[i].style.position="absolute";
                    oBoxs[i].style.top=minH+"px";
                    //oBoxs[i].style.left=oBoxW*index+"px";
                    oBoxs[i].style.left=oBoxs[index].offsetLeft+"px";
                    hArr[index]+=oBoxs[i].offsetHeight;//改变数组
                }
            }
            //console.log(hArr);
        }
        function getByClass(parent,clsName){
            var boxArr=new Array(),oElement=parent.getElementsByTagName("*");//用来存.box元素
            for(var i=0;i<oElement.length;i++){
                if(oElement[i].className==clsName){
                    boxArr.push(oElement[i]);
                }
            }
            return boxArr;
        }

        function getMinhIndex(arr,val){
            for(var i in arr){
                if(arr[i]==val){
                    return i;
                }
            }
        }

        function checkScrollSlide(){
            var oParent=document.getElementById("main");
            var oBoxs=getByClass(oParent,"box");
            var lastBoxH=oBoxs[oBoxs.length-1].offsetTop+Math.floor(oBoxs[oBoxs.length-1].offsetHeight/2);
            var scrollTop=document.documentElement.scrollTop||document.body.scrollTop;
            var height=document.documentElement.clientHeight||document.body.clientHeight;
            return (lastBoxH<scrollTop+height)?true:false;
        }
    </script>
</head>
<body>
    <div id="main">
        <div class="box">
            <div class="pic">
                <img src="images/P_00.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_01.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_02.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_03.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_04.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_05.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_06.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_07.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_08.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_09.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_010.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_011.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_012.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_013.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_014.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_015.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_016.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_017.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_018.jpg" />
            </div>
        </div>
        <div class="box">
            <div class="pic">
                <img src="images/P_019.jpg" />
            </div>
        </div>
    </div>
</body>
</html>